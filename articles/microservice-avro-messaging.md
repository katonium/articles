---
title: "マイクロサービス間のメッセージングスキーマをapache AvroとGoで効率的に管理する"
emoji: "🗂"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
notes:
    - replace-check:
        - トランスパイル: コンパイル
        - Golang: Go言語
        - Apache avro: apache Avro？
    - other: add ``
others:
    - Avroとその他類似の手法の違いについて（ProtoやSwaggerを用いたHTTP/gRPC APIのスキーマ管理）→Avroはシリアライズによってメッセージのサイズを削減できるためメッセージングに特化している？？
    - 可能ならインフラも同様に管理したいが、Terraformでやる手法はよく分からなかった。submodulesを使用してスキーマファイルを参照させれば出来そうだったが、Go言語のように一元管理する方法があればうまく使いたいが、どうなのか。
    - 書きたい内容が混ざっているかも
        - マイクロサービスにおいて、avroをgoに変換することでgo.modに一元化出来て便利
        - submoduleを使っても出来る→別記事
        - terraform moduleを使えばタグ指定できるかも。そこまで出来たらさらに便利→別記事
            - Terraform moduleを使う場合同じリポジトリの複数のスキーマを指定できるのかも大事になってきそう→メジャー違いのQueueが共存する場合など
---


## はじめに
* マイクロサービス間の通信スキーマを管理することで開発速度の向上・運用の安定化に寄与することが出来る。
* 非同期通信のスキーマを管理するために、AvroとGitとGoを使ってgo.modにてバージョンを管理する手法を紹介する。

### マイクロサービス間の通信スキーマ管理の重要性

* 通信スキーマ管理の重要性
    * 特に非同期通信においてはスキーマの誤りが発生すると結構大変
        * Subscriber側で見つかることが多いが、その時点からのリカバリが結構厳しい（オンライン処理のように呼び出し側に失敗を通知することが難しい）
    * スキーマはバージョン
    * また、アプリケーションコードと変更のサイクルが異なるため、リポジトリを分けることが望ましい
* 複数リポジトリ間でのバージョン管理の難しさ
    * Goやその依存モジュールのバージョン管理に加えAvroスキーマの管理が発生すると見通しが悪くなる

### Apache Avroとは
* Apache avroの紹介

### 想定するマイクロサービス間の通信
* パブリッシャーとサブスクライバがPub/Subを介してつながっている状態

## 実装例の紹介
### リポジトリ構成

Avro Schema -> (CI/CD)※別記事の範囲かも。ここではShellscript使う -> Avro Golang repo
Publisher(Go) -> Messaging Service (Cloud Pub/Sub) -> Subscriber(Go)

* とりあえずモノレポで実装は終わらせて、後程リポジトリごと分けて実装する

### 環境の準備
* 解説しない
    * Google Cloudアカウント開設
    * Goのインストール
* gogen-avroのインストール
* トピック・サブスクリプションの作成
```
go install github.com/actgardner/gogen-avro/v10/cmd/...@v10.2.1
```

### スキーマの作成
* Avroスキーマを作成する

### スキーマのコンパイル
* Avroスキーマをコンパイルする


### アプリケーションの実装
* アプリケーションにコンパイルしたスキーマモジュールを追加する
* アプリケーションを実装する。シンプルな実装にする。
* 実装したアプリケーションを疎通させてみる

## まとめ
* マイクロサービスにおいて、avroスキーマのバージョンを効率的に管理する方法を紹介した。


## 他の選択肢に関する考察

今回はAvroをGoにコンパイルする方法を紹介したが、より簡素に実装するためには下記の方法が考えられる。今回紹介した方法と比較したメリット・デメリットに関しても考える。

### 1つのリポジトリに全てのコードを統合する
Avro・送信側アプリケーション・受信側アプリケーションを1つのリポジトリで管理し、コミット断面での動作を保証する。
非常に小さなアプリケーションや、開発の初期段階ではこの手法でも良いと考えられるが、管理が煩雑になる点やスキーマ・送/受信アプリケーション開発者が別であることが多いと思うので、この場合には逆に開発効率が落ちることが考えられる。
（筆者も個人開発の初期段階では1つのリポジトリにすべてのアプリケーションを書くことが多いが、体感としても開発が進むとリポジトリを分散させた方が楽に感じる）


### Git submoduleを用いた管理
リポジトリを分けて管理することが可能。ただしgo.modとsubmoduleによるアプリケーションの依存性管理が共存するため分かりづらくなると感じるので推奨しない。
余談だがアプリケーションが社内の共有ライブラリに依存する場合も同様にsubmoduleよりgo.modに一元管理させた方が見通しが良くなる印象。

## おわりに

